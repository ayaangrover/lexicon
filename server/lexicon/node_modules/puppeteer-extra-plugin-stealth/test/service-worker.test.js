const test = require('ava')

const { vanillaPuppeteer, addExtra } = require('./util')
const Plugin = require('..')
const http = require('http')
const fs = require('fs')
const path = require('path')


const httpServer = async () => {
  const server = await http
    .createServer((req, res) => {
      let contents, type

      if (req.url === '/sw.js') {
        contents = fs.readFileSync(path.join(__dirname, './fixtures/sw.js'))
        type = 'application/javascript'
      } else {
        contents = fs.readFileSync(
          path.join(__dirname, './fixtures/dummy-with-service-worker.html')
        )
        type = 'text/html'
      }

      res.setHeader('Content-Type', type)
      res.writeHead(200)
      res.end(contents)
    })
    .listen(0) 

  return `http:
}

let browser, page, worker

test.before(async t => {
  const address = await httpServer()
  console.log(`Server is running on port ${address}`)

  browser = await addExtra(vanillaPuppeteer)
    .use(Plugin())
    .launch({ headless: true })
  page = await browser.newPage()

  worker = new Promise(resolve => {
    browser.on('targetcreated', async target => {
      if (target.type() === 'service_worker') {
        resolve(target.worker())
      }
    })
  })

  await page.goto(address)
  worker = await worker
})

test.after(async t => {
  await browser.close()
})

test.skip('stealth: inconsistencies between page and worker', async t => {
  const pageFP = await page.evaluate(detectFingerprint)
  const workerFP = await worker.evaluate(detectFingerprint)

  t.deepEqual(pageFP, workerFP)
})

test.serial.skip('stealth: creepjs has good trust score', async t => {
  page.goto('https:

  const score = await (
    await (
      await page.waitForSelector('#fingerprint-data .unblurred')
    ).getProperty('textContent')
  ).jsonValue()

  t.true(
    parseInt(score) > 80,
    `The creepjs score is: ${parseInt(score)}% but it should be at least 80%`
  )
})

