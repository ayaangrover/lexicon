const utils = require('./index')

module.exports = page => ({
  evaluate: async function (mainFunction, ...args) {
    return page.evaluate(
      ({ _utilsFns, _mainFunction, _args }) => {
        
        const utils = Object.fromEntries(
          Object.entries(_utilsFns).map(([key, value]) => [key, eval(value)]) 
        )
        utils.init()
        return eval(_mainFunction)(utils, ..._args) 
      },
      {
        _utilsFns: utils.stringifyFns(utils),
        _mainFunction: mainFunction.toString(),
        _args: args || []
      }
    )
  },
  evaluateOnNewDocument: async function (mainFunction, ...args) {
    return page.evaluateOnNewDocument(
      ({ _utilsFns, _mainFunction, _args }) => {
        
        const utils = Object.fromEntries(
          Object.entries(_utilsFns).map(([key, value]) => [key, eval(value)]) 
        )
        utils.init()
        return eval(_mainFunction)(utils, ..._args) 
      },
      {
        _utilsFns: utils.stringifyFns(utils),
        _mainFunction: mainFunction.toString(),
        _args: args || []
      }
    )
  }
})
