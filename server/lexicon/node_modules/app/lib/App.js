				use(this.onRequest()).
				use(connect['static'](publc, {maxAge: maxAge})).
				use(this.respond404());
			if (log) this.server.
				use(connect.responseTime());
			this.log('Application server ready.');
			return this.forever('setup server');
		};
		obj.connectDB = function () {
			if (this.db) return this;
			this.db = mongoose.connect(
				this.options.dbhost,
				this.options.dbname,
				this.options.dbport
			);
			return this;
		};
		obj.log = function () {
			if (this.options.log) console.log.apply(console, arguments);
			return this;
		};
		obj.listen = function (cb) {
			var that = this,
			    port = this.options.port,
			    host = this.options.host;
			this.log('Building and caching http:
			return this.buildModel(function () {
				that.buildApp(function () {
					that.log('Listening http:
					that.server.listen(port, host, function () {
						that.watchHotCode().buildClient(function () {
							that.log('Finished http:
							cb.call(that);
						});
					});
				});
			});
		};
		obj.close = function () {
			this.server.close();
			if (this.options.hotCode) {
				this.unwatchHotCode();
			}
			return this;
		};
		obj.routes = function (routes) {
			this.router.def(routes);
			return this;
		};
		obj.onRequest = function () {
			var that = this;
			return function (req, res, next) {
				var uri = url.parse(req.url),
				    pth = uri.pathname,
				    route;
				if (that.cache[pth]) {
					that.log('app cache - ' + pth);
					that.cache[pth].call(that, req, res, next);
				} else {
					route = that.router.get(pth);
					if (route && route['']) {
						that.log('app route - ' + pth);
						that.router.send(route, function (r, info) {
							req.routeInfo = info;
							req.query = qs.parse(uri.query);
							req.app = res.app = that;
							r.call(that, req, res, next);
						}, that);
					} else next();
				}
			};
		};
		obj.respond404 = function () {
			var that = this;
			return function (req, res, next) {
				if (util.isFunction(that.custom404)) {
					that.custom404(req, res, next);
				} else {
					res.writeHead(404, {'Content-Type': 'text/plain'});
					res.end('404');
				}
			};
		};
		obj.buildModel = function (cb) {
			this.log('Building models.');
			var that = this;
			return this.scanFiles(
				path.join(this.options.root, 'model'), 1,
				function (dir, file, stats, end) {
					if (file && stats.ext === 'js') {
						var modelName = path.basename(file, '.js');
						that.model[modelName] = require(file)(that);
					}
					end();
				},
				function () {
					that.log('Finished building models.');
					this.connectDB();
					cb.apply(this, arguments);
					that.forever('setup models');
				}
			);
		};
		obj.buildApp = function (cb) {
			this.log('Building app.');
			var that = this;
			this.on('setup models', function () {
				that.scanFiles(
					path.join(this.options.root, 'app'), 1,
					function (dir, file, stats, end) {
						if (file && stats.ext === 'js') {
							var helperName = path.basename(file, '.js');
							that.helpers[helperName] = require(file)(that);
						}
						end();
					},
					function () {
						that.log('Finished building app.');
						cb.apply(this, arguments);
						that.emit('setup app');
					}
				);
			});
			return this;
		};
		obj.buildClient = function (cb) {
			cb.call(this);
			return this;
		};
		obj.buildTest = function (cb) {
			cb.call(this);
			return this;
		};
		obj.watchHotCode = function () {
			if (!this.options.hotCode) return this;
			var that = this,
			    opts = {interval: this.options.watchInterval};
			this.log('Creating model hot code watchers.').scanFiles(
				path.join(this.options.root, 'model'), 1,
				function (dir, file, stats, end) {
					if (file && stats.ext === 'js') {
						var modelName = path.basename(file, '.js');
						fs.watchFile(file, opts, function (curr, prev) {
							if (curr.mtime > prev.mtime) {
								delete require.cache[require.resolve(file)];
								that.model[modelName] = require(file)(that);
							}
						});
					}
					end();
				},
				function () {
					that.log('Finished creating model hot code watchers.');
				}
			);
			this.log('Creating app hot code watchers.').scanFiles(
				path.join(this.options.root, 'app'), 1,
				function (dir, file, stats, end) {
					if (file && stats.ext === 'js') {
						var helperName = path.basename(file, '.js');
						fs.watchFile(file, opts, function (curr, prev) {
							if (curr.mtime > prev.mtime) {
								delete require.cache[require.resolve(file)];
								that.helpers[helperName] = require(file)(that);
							}
						});
					}
					end();
				},
				function () {
					that.log('Finished creating app hot code watchers.');
				}
			);
			return this;
		};
		obj.unwatchHotCode = function (cb) {
			if (!this.options.hotCode) return this;
			var that = this;
			function unwatch (dir, file, stats, end) {
				if (file && stats.ext === 'js') {
					fs.unwatchFile(file);
				}
				end();
			}
			this.scanFiles(
				path.join(this.options.root, 'model'), 1,
				unwatch,
				cb
			);
			this.scanFiles(
				path.join(this.options.root, 'app'), 1,
				unwatch,
				cb
			);
			return this;
		};
		obj.scanFiles = function (dir, depth, fn, cb, _mem) {
			var that = this;
			if (typeof fn !== 'function') return this;
			if (!_mem) _mem = {count: 1};
			if (!_mem.end) _mem.end = function end () {
				_mem.count -= 1;
				if (_mem.count <= 0 && !_mem.called) {
					_mem.called = true;
					cb.call(that);
				}
			};
			fs.readdir(dir, function  (err, files) {
				if (err) throw err;
				if (files.length === 0) {
					return _mem.end();
				}
				var i = 0,
				    end = files.length,
				    last = files[end - 1];
				function iterate (name) {
					var file = path.join(dir, name);
					fs.stat(file, function (err, stats) {
						if (err) throw err;
						function finish () {
							_mem.end();
							if (name === last) {
								_mem.end();
							}
						}
						if (stats.isDirectory() && depth > 0) {
							_mem.count += 1;
							fn.call(that, file, null, stats, function () {
								that.scanFiles(file, depth - 1, fn, null, _mem);
								if (name === last) {
									_mem.end();
								}
							});
						} else if (stats.isFile()) {
							_mem.count += 1;
							stats.ext = path.extname(file).substr(1);
							stats.encoding = mime.lookup(file);
							stats.charset = mime.charsets.lookup(stats.encoding);
							fn.call(that, dir, file, stats, finish);
						} else {
							finish();
						}
					});
				}
				for (; i < end; i += 1) iterate(files[i]);
				return null;
			});
			return this;
		};
		if (args) obj.initApp.apply(obj, args);
		return obj;
	};
	(module.exports = App).create(App.prototype);
}).call(this);