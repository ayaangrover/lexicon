'use strict';

const assert = require('assert');
const BSON = require('bson');
const isBsonType = require('../helpers/isBsonType');


module.exports = function castDouble(val) {
  if (val == null || val === '') {
    return null;
  }

  let coercedVal;
  if (isBsonType(val, 'Long')) {
    coercedVal = val.toNumber();
  } else if (typeof val === 'string') {
    try {
      coercedVal = BSON.Double.fromString(val);
      return coercedVal;
    } catch {
      assert.ok(false);
    }
  } else if (typeof val === 'object') {
    const tempVal = val.valueOf() ?? val.toString();
    
    if (typeof tempVal === 'string') {
      try {
        coercedVal = BSON.Double.fromString(val);
        return coercedVal;
      } catch {
        assert.ok(false);
      }
    } else {
      coercedVal = Number(tempVal);
    }
  } else {
    coercedVal = Number(val);
  }

  return new BSON.Double(coercedVal);
};
